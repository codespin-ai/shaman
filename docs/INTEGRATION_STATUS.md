# Shaman Integration Status

This document provides a clear status of external service integrations in Shaman.

## Active Integrations

### Foreman - Workflow Orchestration ✅

- **Status**: Fully integrated and actively used
- **Package**: `@codespin/foreman-client` v0.0.2
- **Used in**:
  - `shaman-a2a-server` - For creating runs and tasks
  - `shaman-worker` - For task processing
- **Configuration**:
  - `FOREMAN_ENDPOINT` - Required (default: http://localhost:3000)
  - `FOREMAN_API_KEY` - Required
  - `SHAMAN_TASK_QUEUE` - Optional queue name override
  - `SHAMAN_RESULT_QUEUE` - Optional queue name override

## Planned Integrations (Not Yet Implemented)

### Permiso - RBAC Authorization ❌

- **Status**: Documentation exists but NO active integration
- **Package**: `@codespin/permiso-client` - Not installed in any package
- **Current Auth**: Handled internally by `shaman-security` package using:
  - JWT tokens for internal service-to-service calls
  - API keys for external authentication
- **Configuration (Reserved for future use)**:
  - `PERMISO_ENDPOINT` - Would connect to Permiso GraphQL API
  - `PERMISO_API_KEY` - Optional API key
- **Future Benefits**:
  - External RBAC management
  - Fine-grained resource permissions
  - Multi-tenant organization isolation

### Ory Kratos - Identity Management ❌

- **Status**: Referenced in docs but NO active integration
- **Current Auth**: API keys only (no session management)
- **Future Benefits**:
  - User session management
  - Self-service flows (login, registration, recovery)
  - Identity validation

## Current Authentication Implementation

Since Permiso and Kratos are not integrated, Shaman currently uses:

1. **API Keys** for external authentication
   - Stored in database with hashed keys
   - Validated by `shaman-security` package
2. **JWT Tokens** for internal service communication
   - Generated by `shaman-security`
   - Used between a2a-server instances
   - Short-lived (5 minute expiry)

3. **Row Level Security** for multi-tenancy
   - PostgreSQL RLS policies
   - Organization ID context setting
   - Enforced at database level

## Documentation Updates Made

To accurately reflect the current state, the following documentation has been updated:

1. **README.md** - Separated active vs planned external services
2. **architecture.md** - Marked Permiso and Kratos as planned integrations
3. **getting-started.md** - Removed Permiso from prerequisites
4. **CLAUDE.md** - Clarified which integrations are active
5. **api.md** - Noted that session auth is planned but not implemented
6. **external-dependencies/README.md** - Clearly marked integration status
7. **external-dependencies/permiso-docs/README.md** - Added note about planned status

## Migration Path

When ready to integrate Permiso:

1. Install `@codespin/permiso-client` in relevant packages
2. Replace internal permission checks with Permiso API calls
3. Migrate existing roles/permissions to Permiso
4. Update GraphQL resolvers to check permissions via Permiso
5. Remove internal RBAC code from `shaman-security`

When ready to integrate Kratos:

1. Add Kratos SDK to `shaman-gql-server`
2. Implement session middleware
3. Add login/logout endpoints
4. Update GraphQL context to use Kratos sessions
5. Implement self-service UI flows
